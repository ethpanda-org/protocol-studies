# 共识层概述

共识协议的主要目标是在不可靠的基础设施上构建一个可靠的分布式系统。对共识协议的研究可以追溯到 20 世纪 70 年代，但以太坊试图实现的目标远比之前的研究更具野心。

在以太坊的共识层中，目标是确保全球成千上万的独立节点保持合理同步。每个节点都维护着包含所有账户状态的账本，这些账本必须完全一致，不允许有任何差异，节点之间必须快速达成一致，这也就是我们所说的“可靠的分布式系统”。

这些节点通常使用[消费级硬件](https://stakefromhome.com/)并通过可能速度较慢、丢失数据或意外断开连接的互联网通信。节点操作员可能会错误配置软件或未能及时更新。此外，可能有许多恶意参与者运行伪造节点或篡改通信以谋取私利。这就是我们所说的“不可靠的基础设施”。

### 拜占庭容错（BFT）和拜占庭将军问题

拜占庭容错（Byzantine Fault Tolerance, BFT）是分布式系统的一种特性，它允许分布式系统在某些组件发生故障或恶意行为时仍能正常。运行BFT 在去中心化网络中尤为重要，因为这些网络中的节点之间无法假设存在信任关系。换句话说，具备 BFT 的系统可以容忍拜占庭故障，即包括恶意行为在内的任意故障。为了实现拜占庭容错，系统必须在存在这些故障的情况下达成共识。关于这个问题及其实际解决方案的更多信息，请参阅[这里](https://hackmd.io/@kira50/SknuPZMIC)。

## 共识层简介

> 共识是一种利用不可靠组件构建可靠分布式系统的方法。基于区块链的分布式系统旨在就一系列交易的单一历史达成一致。
>
> 工作量证明（Proof-of-work）和权益证明（Proof-of-stake）并不是共识协议，而是使共识协议成为可能的机制。在以太坊中，节点和验证者是共识系统的执行者。slots 和 epochs 调控共识的时间, 区块和证明是达成共识的价值媒介

共识层是确保网络安全性、可靠性和效率的基础组件。最初，以太坊采用类似比特币的工作量证明（Proof-of-work, PoW）作为共识机制。虽然 PoW 在保持去中心化和安全性方面非常有效，但也有着显著缺点，比如其高能耗和有限的可扩展性。为了解决这些问题，以太坊已转向更可持续和可扩展的权益证明（Proof-of-stake, PoS）机制。

以太坊网络由许多独立节点组成，每个节点独立运行，通过互联网进行通信，而互联网往往不可靠并且是异步的

用户将交易发送到这些节点组成的网络，共识协议确保所有诚实的节点最终达成唯一且一致的交易历史，这意味着它们会就交易的顺序及其结果达成一致。例如，如果我有 1 ETH，并同时告诉网络将其发送给 Alice 和 Bob，网络最终必须决定我到底将其发送给了 Alice 还是 Bob。如果 Alice 和 Bob 都收到了这笔 Ether，或者两者都未收到，那将是失败的。共识协议就是促成交易顺序上达成一致的过程

以太坊的共识协议实际上结合了两种不同的共识协议。一个被称为 [LMD GHOST](https://epf.wiki/#/wiki/CL/gasper.md?lmd-ghost)，另一个是 [Casper FFG](https://epf.wiki/#/wiki/CL/gasper.md?casper-ffg)。两者的结合被称为 [Gasper](https://epf.wiki/#/wiki/CL/gasper.md)。在后续部分中，我们将分别和结合地探讨它们。

## 工作量证明与权益证明

在这里需要澄清，工作量证明（PoW）和权益证明（PoS）本身并不是共识协议。它们通常被错误地这样称呼，但实际上它们是使共识协议成为可能的机制。PoW 和 PoS 的主要作用是作为 Sybil 攻击的抗性机制，为参与协议设置成本代价，从而防止攻击者以低成本压垮系统。

PoW 和 PoS 都是通过[分叉选择规则](https://epf.wiki/#/wiki/CL/cl-architecture.md?id=fork-choice-rules)与它们支持的共识机制紧密相连。它们帮助为区块链分支分配权重或评分：在 PoW 中，是完成的计算总工作量；在 PoS 中，这是支持特定链的总抵押价值。在这些基本原理之上，PoW 和 PoS 可以支持各种共识协议，每种协议都有其自身的动态和权衡。


## 区块链概述

区块是区块链的基本构成单位, 一个区块是由领导者（区块提议者）组装的一组交易组成，区块的具体内容会依据协议的不同而有所变化。

- 在以太坊执行链上，区块的有效负载是用户交易的列表
- 在合并前的 PoS 信标链上，区块的有效负载主要由区块验证者的一系列证明组成
- 合并后的信标链区块同时包含执行的有效负载（用户的交易集合）。
- 自 [EIP-4844](https://eips.ethereum.org/EIPS/eip-4844)（Deneb 升级）后，区块还包含了不透明数据 blob 的承诺。

除了创世区块，每个区块都建立在父区块之上并指向父区块，形成一个区块链。网络中的所有节点的目标是对相同的规范区块链历史达成一致。

<a id="img_blockchain"></a>

<figure class="diagram" style="text-align:center">

![Blockchain](./images/cl/blockchain.svg)

<figcaption>

_时间从左向右推进，除了创世区块，每个区块都指向其构建的父区块_

</figcaption>
</figure>

链随着节点向其末端添加新块而增长, 这是通过暂时选择一个“领导者”（延长链条的节点）来实现的。在 PoW 中，领导者是第一个为其区块解决 PoW 难题的矿工。在以太坊的 PoS 中，提议者（领导者）是从活跃验证者集中伪随机选出的。

领导者（区块提议者）将区块添加到链中，选择并排序其内容。区块必须符合协议规则，否则网络将忽略它。使用区块是一种优化。如果逐一添加交易，将产生巨大的共识开销。因此，区块是交易的批处理。在以太坊执行链中，区块大小受区块 gas （处理交易所需的费用）限制。[信标区块](https://epf.wiki/#/wiki/CL/beacon-api?id=beaconblockbody)大小则受硬编码常量限制。


## 过渡到权益证明
> 2022 年 9 月 15 日，以太坊完成了从工作量证明（PoW）到权益证明（PoS）的转变，这一新机制被称为共识层，也就是被称为以太坊 2.0 的信标链。

以太坊的巴黎硬分叉（合并）基于“终端总难度”（TTD）而非区块高度激活，以避免恶意分叉等风险。这确保了 PoS 转变仅在累计难度达到关键阈值时发生。终端区块是最后一个 PoW 区块，其总难度超过预定义阈值，从而确保安全性。总难度是递归计算得出的，反映了区块链中的计算工作量。

这一点至关重要，因为测试网、开发网以及任何运行最新软件的以太坊网络都需要通过总终端难度（TTD）而非区块高度来激活合并。更多细节请参考[过渡标准]((https://hackmd.io/@kira50/rJ2y7jImR))和[总终端难度]((https://bordel.wtf))

> **译者注:**
> TTD 是以太坊网络中计算出的一个阈值，它表示区块链中累计计算难度的总和, 当某个区块的总难度达到或超过这个阈值时，就触发权益证明的激活。
> 
> 为什么使用 TTD 而不是区块高度：
> - 安全性：区块高度是一个简单的计数器，但容易受到攻击者通过快速生成低质量区块（恶意分叉）的操控。
> - 动态性：总难度反映了实际的计算工作量，能够更好地适应 PoW 网络中的计算波动，确保过渡时机更加自然和安全

合并引入了以下变化：

1. **信标链接管**：信标链, 已与以太坊主网并行运行,接管了处理新区块的责任。在 PoS 中，区块由抵押 ETH 的验证者验证，而非通过矿工解决密码学难题。
2. **安全性和效率**：此转变不仅旨在通过去中心化增强以太坊网络的安全性，还显著减少了能源消耗，解决了这一关于传统工作量证明（PoW）系统的主要批评
3. **新的共识机制**：在权益证明（PoS）机制下，共识的达成依赖于质押、验证者的证明以及随机选择区块提议者和委员会的算法相结合，以此确保网络的安全性并高效处理交易。


### 信标链简介

信标链在 PoS 共识管理中起着关键作用。它监管着提出新区块并对其进行验证的验证者，确保网络的完整性与安全性。验证者的选择基于多个标准，其中之一是他们抵押的 ETH 数量，这也作为防止不诚实行为的担保。

验证者的主要职责包括：

1. **抵押 ETH**：验证者必须抵押至少 32 ETH 才能参与。
2. **提议区块**：随机选中的验证者负责提议新区块，必须构建有效区块并将其广播至网络。
3. **区块认证**：验证者对其他人提议的区块的有效性进行认证。这些认证本质上是对区块有效性的投票，确保共识。
4. **参与共识**：通过定期投票帮助最终确定区块链状态。

巴黎硬分叉是以太坊历史上的一个关键事件，为更可扩展、可持续和安全的操作奠定了基础。它代表了以太坊对创新的承诺，以及其对加密货币挖矿环境影响这一更广泛社会关切的积极响应

## 信标链及其基础

信标链是以太坊共识机制的核心支柱。它负责协调验证者、管理权益证明（PoS）协议，并确保整个网络达成共识。本节将深入剖析信标链的构成与运作原理。

### 验证者
验证者本质上是 PoS 协议中的参与者。他们负责提议和验证新区块，确保区块链的完整性与安全性。验证者需质押ETH作为抵押，以此将其利益与网络的健康状况绑定。验证者被选中提议区块，基于以下因素：

1. **抵押 ETH**：每个验证者最多可抵押 32 ETH，拥有更多以太币（ETH）的质押者可以通过运行多个验证节点来增强其影响力，每个节点需质押32 ETH。这一机制确保了网络的去中心化，并使验证者的利益与网络的安全性和完整性保持一致
2. **随机性**：选择选拔过程融入了加密随机性，以防止可预测性和操纵行为。这一目标通过[RANDAO](https://inevitableeth.com/home/ethereum/network/consensus/randao) 和 [VDF（可验证延迟函数）](https://inevitableeth.com/home/ethereum/upgrades/consensus-updates/vdf)机制得以实现
3. **委员会**：验证者被分组为委员会，负责区块提议和验证工作。每个委员会的任务是验证并对区块进行确认，以此保障去中心化且安全的验证流程
4. **质押要求**： 要成为验证者，个人需向官方存款合约存入至少32个以太币（ETH）。这些ETH作为抵押，旨在激励诚实行为。若验证者未能履行职责或参与恶意活动，其 ETH 将面临被扣除的风险


### Slots 与 Epochs

每个 slot 为12秒，一个 Epoch 包含 32 个 slot，合计384秒或6.4分钟。每个 slot 都分配有验证者来提议一个区块，而由验证者组成的委员会则负责确认该区块的有效性

一个 slot 代表在信标链上添加一个区块的机会，每12秒便有一个区块被添加。
> 译者注:
> 如果提议者因为节点离线，网络延迟等原因未能按时完成区块提议或者提议者的行为被视为无效，即无效区块，可能会导致该 slot 空置

验证者需要与[时间同步]((https://ethresear.ch/t/network-adjusted-timestamps/4187))。slot类似于区块时间，但slot可能为空（未添加区块）。信标链的创世区块位于时隙0

<a id="img_slots_epochs"></a>

<figure class="diagram" style="margin-left:10%; width:80%">

![Diagram for slots and epoch](../../images/cl/slots-and-epochs.png)

<figcaption style="margin-left: 15%">

_第一个 32 个slot属于第 0 epoch. 信标链的创世区块位于第 0 slot，_

</figcaption>
</figure>

### 验证者与证明
区块提议者是被伪随机选中的验证者，负责构建区块。验证者们不仅提出区块，还对他人提出的区块进行认证。大多数时候，验证者扮演着投票者的角色，对区块进行表决。这些投票记录在信标链上，并决定了信标链的头部位置

证明是对区块有效性的投票，这些投票被汇总到信标链中以确保共识。

<a id="img_validators"></a>

<figure class="diagram" style="margin-left:10%; width:80%">

![Diagram for Validator selection](../../images/cl/validators.png)

<figcaption style="margin-left: 15%">

_如图所示，在第28个slot处，可能会出现slot为空的情况_

</figcaption>
</figure>

每个证明都是是一个验证者的投票，其权重取决于验证者的质押量。除了区块外，验证者还会广播这些证明。验证者之间相互监督，对于举报那些做出矛盾投票或提议多个区块的其他验证者，会获得奖励

信标链的内容主要包括验证者地址的注册表、每个验证者的状态以及证明。验证者由信标链激活，并能转换至不同状态。

**关于质押验证者语义的重要说明**：在以太坊的权益证明（PoS）机制中，用户通过质押ETH来激活验证者，这类似于在工作量证明（PoW）中购买硬件设备。质押者与其质押的ETH数量相关联，而每个验证者的最大余额为32 ETH。每质押32 ETH，即可激活一个验证者。验证者由验证者客户端运行，这些客户端通过信标节点来跟踪并读取信标链。一个验证者客户端能够管理多个验证者


### 委员会
委员会是在每个slot时，由至少128名被分配验证者组成的群体，用以加强安全性。攻击者控制委员会三分之二成员的概率低于万亿分之一。

随机信标的概念，即向公众发布随机数的机制，正是信标链得名的由来。信标链通过一个名为RANDAO的伪随机过程来强制执行共识

<a id="img_randao"></a>
<figure class="diagram" style="text-align:center">

![Diagram for Validator selection](../../images/cl/RANDAO.png)

<figcaption>

_每个 epoch，一个伪随机过程RANDAO会为每个slot(slot)选择提案者，并将验证者分配到各个委员会中._

</figcaption>
</figure>

**验证者的选择:**
- 如上所述，验证者由RANDAO选出，其权重依据验证者的余额而定
- 验证者可能同时担任提案者和委员会成员，但这种情况较为罕见（概率为1/32）

下图描绘了验证者数量少于 8192 个的情形，否则每个slot 至少会有两个委员会
<a id="img_committee"></a>
<figure class="diagram" style="margin: auto; width:80%">

![Diagram for Committees](../../images/cl/committees.png)

</figure>
上图还描述了三个slots 内发生的事件:

- slot1：一个区块被提出并由两位验证者确认；其中一位验证者离线。
- slot2：一个区块被提出，但一位验证者错过了，去确认了前一个区块。
- slot3：遵循LMD GHOST规则，委员会C中的所有验证者都确认了同一个头部区块。

验证者通过LMD GHOST规则对Beacon Chain的头部视图进行认证。认证通过就区块链状态达成共识，有助于区块的最终确认

**委员会规模与安全性：**
- 拥有超过 8192 个验证者时，每个 slot 会形成多个委员会。
- 为了达到最佳安全性，每个委员会至少需要128名验证者。
- 当验证者数量少于 4096 时，由于委员会规模降至128以下，安全性会随之降低

> 在每个 epoch，验证者被均匀分配到各个 slot，并进一步细分为大小适宜的委员会。该 slot 内的所有验证者都对信标链的头部进行认证。一种洗牌算法会根据需求调整每个 slot 的委员会数量，确保每个委员会至少有128名验证者。关于洗牌算法的更多细节，可在[proto 代码库]((https://github.com/protolambda/eth2-docs#shuffling))中找到


### Blobs
[EIP-4844](https://eips.ethereum.org/EIPS/eip-4844)，又称proto-danksharding，是Deneb/Cancun硬分叉的一部分。它为以太坊引入了数据可用性层，使得在区块链上临时存储任意数据成为可能。以这种方式存储的任意数据被称为 `blob`，每个区块可包含3 至 6个 blob sidecars（即blob的封装）。EIP-4844标志着以太坊迈向分片和可扩展性的第一步，使第二层解决方案（L2s）能够利用这一数据可用性层来降低 gas 费用并处理更多交易

#### 设计与实现
EIP-4844中的一项关键设计决策是采用 [KZG 承诺](https://github.com/eth-protocol-fellows/protocol-studies/blob/main/docs/wiki/Cryptography/KZG.md) 来验证数据块（blobs）并支持未来提议者与构建者的分离。为了使用KZG承诺，需要一个可信设置（Trusted Setup）。针对Deneb硬分叉，通过实施 [KZG Ceremony](https://github.com/ethereum/kzg-ceremony) 以创建这一可信设置。
<a id="img_blobs"></a>

<figure class="diagram" style="text-align:center">

![Diagram for Blobs](../../images/cl/blobs.png)

</figure>

### 存储要求
对节点运营商最显著的影响是存储需求的增加。节点运行者将需要更多的存储空间：
```
131,928 ssz bytes per blob * 4096 blobs retention period * 
32 potential blocks per epoch * 3~6 blob sidecars per block

= 52~104GB
```
默认情况下，这些数据块将保留4096个 epoch，一旦达到保留期限，客户端将删除最旧的数据块。

### 检查点与最终确认
每个 `epoch` 结束时，都会创建检查点。检查点是该 `epoch` 第一个 `slot` 中的区块。若该`slot`无区块，则检查点为之前最近的一个区块。每个 `epoch` 总有一个检查点区块，而一个区块可能成为多个 `epoch` 的检查点

<a id="img_checkpoints"></a>
<figure class="diagram" style="text-align:center">

![Diagram for checkpoints](../../images/cl/checkpoints.jpg)

<figcaption>

_包含 64个 slots 的 epoch 场景下的检查点_

</figcaption>
</figure>

如上图所示，若第65至128号 slot 为空，则 epoch 2 的检查点默认指向第64 号 slot的区块。同理，若第192 号slot 空缺，epoch 3 的检查点即为第 180 号 slot 的区块。**Epoch 边界区块**(EBB)是部分文献（如上述图表来源及后续提及的 [Gasper](https://arxiv.org/abs/2003.03052) 论文）中的术语，它们可视为检查点的同义词

验证者进行两种类型的投票：`LMD GHOST` 投票针对区块，`Casper FFG` 投票针对检查点。一次 `FFG` 投票包含来自前一个 Epoch 的一个源检查点和当前 Epoch 的一个目标检查点。例如，Epoch 1 的验证者可能投票支持创世区块作为源检查点，以及第64个 slot 作为目标检查点，并在Epoch 2 重复相同的投票。只有被分配到特定 slot 的验证者才会进行 LMD GHOST 投票，而所有验证者都会对 epoch 检查点进行FFG投票

#### 绝对多数（Supermajority ）和最终确认
要使一个检查点得到验证，需要获得绝对多数支持，即三分之二以上的验证者支持。例如，若验证者的余额分别为 8 ETH、8 ETH和32 ETH，那么绝对多数就意味着需要 32 ETH验证者的投票支持。一旦某个检查点获得绝对多数支持，它便被视为已证明。若后续 epoch 的检查点同样获得证明，前一个检查点则被最终确认，从而确保所有之前区块的安全。通常，这一过程跨越两个 Epoch（12.8分钟）。

当用户交易被打包进一个区块时，平均而言，它大约位于一个 epoch 的中间位置。到达下一个检查点需要半个 epoch，约3.2分钟，这意味着交易最终确认需要2.5个 epoch，即16分钟。理想情况下，超过三分之二的验证会在一个 epoch 的第22个（32的三分之二）slot 内完成。因此，交易的最终确认需要平均为14分钟（16+32+22个 slots）。

区块确认过程始于区块的验证证明，随后推进至其合理性验证，最终达到不可逆的最终确认。具体应用场景可自行决定是否需要最终确认，还是更早的安全阈值就已足够。

<a id="img_finality"></a>
<figure class="diagram" style="text-align:center">

![Diagram for Finality](../../images/cl/finalization.png)

<figcaption>

_示例：一个检查点（slot 64）被证明合理，并最终确定了前一个检查点（slot 32）_

</figcaption>
</figure>

**信标链头发生的情况**：在 slot 96，提出了一个包含对 Epoch2 的检查点认证（投票）的区块，当认证达到了所需的三分之二绝对多数时，Epoch2 检查点的合理性也就被确认了。这一操作最终确定了之前已验证的 Epoch 1 检查点。当 Epoch 1检查点被最终确认时，所有之前的区块（直至 slot 32）也随之被最终确认。最终确认发生在 Epoch 边界，但认证会随着每个区块的提出而累加。

**从创始区块到信标链头可能发生的情况:**
- 场景 1：
    1. 从Slot 1到Slot 63的提议者提出区块。
    2. Epoch 1中的每个区块都为Slot 32的检查点提供证明，最终达到55%。
    3. Slot 64的区块包含额外的证明，使对Slot 32检查点的支持率达到70%，从而使其得到验证。
    4. 在整个Epoch 2期间，Slot 64的检查点收集证明，但直到Slot 96才达到三分之二的门槛，此时它被验证。
    5. 验证Epoch 2的检查点会最终确定Epoch 1的检查点及之前的所有区块
- 场景 2:
    1. Epoch 1 的检查点有望在到达下一 Epoch 前达到三分之二以上的绝对多数支持。
    2. 例如，从第32 slot 到第 54 slot (2/3 epoch ~= 22 个 slot)的区块能够提供足够的证明，使第32 slot 的检查点得以验证。这样一来，第32 slot 的检查点将在当前 Epoch 内得到验证，但仍需到下一 Epoch 才能最终确认

**特殊情况**：检查点的合理性有时可以确认两个或更多 epoch 前的区块，尤其是在高延迟、网络分区或遭受攻击期间。你可以在Gasper论文中找到更多此类案例的讨论。这些情况属于例外，并非常态

#### 深入探究认证机制
验证者每个 epoch 提交一次证明，包含 LMD GHOST 和 FFG投票结果。这些证明每个 epoch 期间有 32 次被打包记录到链上的机会，越早上链奖励越高。这意味着一个验证者在一个 epoch 内可能有两个证明被纳入链上。当验证者的证明在其指定时段被记录到链上时，他们获得的奖励最多；之后的奖励会递减。为了让验证者有准备时间，他们会提前一个 epoch 被分配到委员会中。与验证者不同，区块提议者（proposers）只有在 Epoch 开始后，才会被分配到特定的 Slot。在此之外，也有[秘密领导者选举](https://ethresear.ch/t/low-overhead-secret-single-leader-election/5994)研究旨在减轻对提议者的攻击或贿赂

假设在Slot 64提出的一个区块，其中包含对Epoch 2检查点的证明。这种情况下，第32个 slot 的检查点可以被最终确认。一旦Slot 32 检查点的最终性得以实现，这种确定性将向后传播，确保所有先前区块的安全性。

本质上，委员会其实允许将每个证明者的签名技术性地优化组合成一个单一的聚合签名。当同一委员会中的验证者做出相同的LMD GHOST和FFG投票时，他们的签名可以被聚合起来。

### 质押奖励与惩罚
以太坊的权益证明（PoS）系统采用了一套全面的奖励与惩罚机制，以激励验证者行为并维护网络安全。本节将探讨这些激励措施的六大关键方面：

1. **验证者奖励**：验证者因做出与大多数其他验证者一致的见证（LMD GHOST和FFG投票）而获得奖励。被打包进最终确认区块的见证更具价值
2. **验证者惩罚机制**：验证者若未能进行证明或对提交的见证支持了未被最终确认（finalized）的区块，将受到惩罚。这些惩罚措施旨在确保验证者保持活跃状态，并与网络的共识保持一致
> 译者注:
> 
> 惩罚的具体机制
>
>- 离线罚款（inactivity leak）：验证者长时间离线或未能提交见证，将持续被扣罚质押 ETH。在极端情况下，如果离线验证者的数量较多，网络会进入 inactivity leak 模式，加速对离线验证者的惩罚，以保障网络的稳定性
> 
> - 错误见证罚款：验证者支持了一条分叉链，导致其见证未能与网络共识一致。情节严重时，例如验证者被恶意行为者攻击或贿赂，故意支持错误的链头，可能会触发 惩罚退出（slashing），质押的 ETH 将被部分或全部销毁

3. **典型的质押者下行风险**：质押者可以通过比较潜在收益与惩罚来估算其下行风险。一个诚实的验证者一年内若获得10%的收益，可能因表现不佳而损失高达7.5%。短期不活跃会面临小额惩罚，而长时间离线则会招致更重的处罚
4. **惩罚与举报奖励机制**：惩罚机制针对严重违反协议的验证者实施，罚金从超过0.5 ETH直至全部质押金额不等。例如，若验证者做了违反规则的行为，将至少损失其余额的 1/32 并被停用。额外罚金则与同时受罚的验证者数量成正比。举报可罚行为的举报人将获得奖励，目前该奖励归区块提议者所有
5. **提案者奖励**：当区块提案者(proposers) 提议的区块被成功加入区块链并最终确定后，他们将获得丰厚的奖励。持续表现良好的验证者其总奖励大约增加1/8。此外，提案者若在其区块中包含惩罚证据，还能获得小额奖励
6. **不活跃泄漏惩罚**：不活跃泄漏是一种严厉的惩罚机制，旨在确保网络最终性。若最终性延迟超过四个 epoch，验证者将承受递增的惩罚，直至某个检查点被最终确认。此机制会耗尽不活跃验证者的余额，迫使其退出，从而使活跃验证者能够达到 2/3 大多数，网络恢复最终性。在不活跃泄漏期间，仅能获得提案者和举报者奖励，而证明者奖励为零

### 可能会被惩罚的行为
验证者可能遭受惩罚的四种情形如下：
- **重复提案**：区块提案者(proposers)在被分配到的 Slot 中提议了多个区块
- **LMD GHOST 重复投票**：在同一个 Slot 上对不同的信标链头（Beacon Chain Head）进行投票
- **FFG环绕投票**：投出了一个环绕或被同一验证者之前的FFG投票所环绕的 FFG投票
> 译者注:
> 环绕指的是新的投票范围完全包裹了以前投票的范围，或反之。
> 
>示例：以前的 FFG 投票范围是 source: Epoch 3 -> target: Epoch 5。新的投票范围是 source: Epoch 2 -> target: Epoch 6。
>
>问题：FFG 的目标是确保区块链最终性，环绕投票破坏了这种逻辑。可能被用来延迟最终性或操纵网络状态

- **FFG 重复投票**：在同一个 Epoch 内，验证者对不同的目标进行了两个 FFG 投票

## 信标链验证者激活与生命周期：
激活一个验证者需要32个ETH。若其余额降至16个ETH，验证者将被停用，剩余余额可提取。验证者在服务满2048个 epoch（约九天）后，亦可自愿退出。

退出时，需经历四个 epoch 的延迟方可提款，在此期间验证者仍可能遭受罚没.

信用良好的验证者可以在大约 27 小时内提取其余额，而受到处罚的验证者则需等待约36天（8192个 epoch）才能进行提款
<a id="img_randao"></a>
<figure class="diagram" style="text-align:center">

![Diagram for Validator Lifecycle](../../images/cl/validator-lifecycle.png)

</figure>

为了防止验证者集合的快速变动，机制上限制了每个 epoch 内可以激活或退出的验证者数量。此外，信标链还采用了有效余额进行技术优化，其变动频率低于验证者的实际余额
> 译者注：
> 
> - 实际余额（Actual Balance）：是验证者的真实账户余额，表示验证者账户上确切拥有的 ETH 数量，会随着质押奖励（或惩罚）的增加或减少而频繁变化。
> - 有效余额（Effective Balance）：是一个用于奖励和惩罚计算的平滑值，通常会向下取整到某个固定的单位（例如 1 ETH）。有效余额的变化频率比实际余额低
> 
> 为什么需要有效余额？
>1. **减少频繁的状态更新**: 如果直接使用实际余额进行奖励和惩罚计算，那么每次验证者的余额发生变化时，都会触发网络状态更新。状态更新是昂贵的，因为它需要被所有节点同步。使用有效余额可以限制状态更新的频率，从而降低网络的计算和通信成本。
>2. **提高计算效率**: 奖励和惩罚通常按有效余额的比例计算。如果实际余额每次变化都需要重新计算，会增加复杂性。有效余额通过简化计算，提升网络运行效率。
>3. **平滑奖励和惩罚波动**: 实际余额的频繁波动可能导致奖励或惩罚波动过大，影响验证者的经济预测。有效余额通过限制变化频率，使奖励和惩罚更平滑、更可预测

#### 总体效果
每个 epoch 期间，验证者被均匀分配到各个 slot，并进一步细分为适当规模的委员会。验证者只能存在于一个 slot，且仅属于一个委员会。总体而言:
- 在一个 epoch 内，所有验证者都试图最终确认同一个检查点：FFG投票
- 分配给同一 slot 的所有验证者都尝试对相同的信标链头部进行投票：LMD GHOST投票，最优行为(对当前权重最大的链头进行投票)使验证者将获得最多的奖励

2020年12月1日，信标链启动时，初始拥有 21,063 名验证者。验证者数量可能因惩罚或自愿退出而减少，也可能有更多质押者加入并激活。时至今日（2024年5月15日），以太坊网络上活跃的验证者已超过1,000,000名。世界从未见过像以太坊这样可扩展的去中心化系统和应用平台。

### 引用资源

- [Beacon Chain Explainer from ethos.dev](https://ethos.dev/beacon-chain)
- [Evolution of Ethereum Proof-of-Stake](https://github.com/ethereum/pos-evolution/blob/master/pos-evolution.md)
- Alt Explainer, [Ethereum's Proof-of-Stake consensus explained](https://www.youtube.com/watch?v=5gfNUVmX3Es)
- [Eth2 Handbook by Ben Edgington](https://eth2book.info/capella/part2/consensus/)
